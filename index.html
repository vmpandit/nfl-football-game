<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFL Pro Season - Enhanced v5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            overflow: hidden;
            touch-action: none;
        }

        #gameContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            transition: transform 0.1s ease-out;
        }

        #gameCanvas {
            background: linear-gradient(to bottom, #2d5016 0%, #1a3a0f 100%);
            border: 4px solid #fff;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border-radius: 8px;
            max-width: 100%;
            max-height: 90vh;
            cursor: pointer;
        }

        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ui-panel {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            border: 2px solid #3b82f6;
        }

        .ui-title {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-info {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: white;
        }

        .play-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 15px 0;
        }

        .play-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            position: relative;
        }

        .play-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .play-button.run {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .play-button.pass {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .play-button.defense-coverage {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .play-button.defense-pressure {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .action-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            transform: scale(1.05);
        }

        .action-button.secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        .controls-key {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-size: 12px;
            z-index: 999;
            max-width: 320px;
        }

        .controls-key h4 {
            margin: 0 0 10px 0;
            color: #3b82f6;
            font-size: 14px;
            border-bottom: 1px solid #3b82f6;
            padding-bottom: 5px;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
        }

        .control-key {
            background: rgba(59, 130, 246, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
        }

        .team-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .team-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: white;
            border: 2px solid transparent;
        }

        .team-card:hover {
            border-color: #3b82f6;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .big-play-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 64px;
            font-weight: bold;
            color: #fbbf24;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            z-index: 2000;
            pointer-events: none;
            animation: bigPlayBurst 2s ease forwards;
        }

        @keyframes bigPlayBurst {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3) rotate(5deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; }
        }

        .play-clock-warning {
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Set canvas size
        function resizeCanvas() {
            const maxWidth = Math.min(window.innerWidth - 20, 1200);
            const maxHeight = Math.min(window.innerHeight - 20, 800);
            const aspectRatio = 1.5;
            
            if (maxWidth / maxHeight > aspectRatio) {
                canvas.height = maxHeight;
                canvas.width = maxHeight * aspectRatio;
            } else {
                canvas.width = maxWidth;
                canvas.height = maxWidth / aspectRatio;
            }
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game State
        const gameState = {
            mode: 'menu',
            playerName: '',
            difficulty: 'pro',
            nflTeams: [],
            season: {
                week: 1,
                playerTeam: null,
                teams: [],
                schedule: []
            },
            game: {
                quarter: 1,
                timeLeft: 900,
                playClock: 40,
                playClockActive: false,
                playClockShouldStart: false,
                possession: 'player',
                down: 1,
                yardsToGo: 10,
                ballPosition: 25,
                playerScore: 0,
                opponentScore: 0,
                selectedPlay: null,
                players: [],
                ballCarrier: null,
                gamePhase: 'setup',
                opponent: null,
                stats: {
                    passingYards: 0,
                    rushingYards: 0,
                    totalYards: 0,
                    touchdowns: 0,
                    turnovers: 0
                }
            },
            input: {
                mouseX: 0,
                mouseY: 0,
                touching: false,
                keys: {}
            }
        };

        // Difficulty settings
        const DIFFICULTY = {
            rookie: { defenderSpeed: 0.7, successBonus: 0.15, fumbleChance: 0.02, intChance: 0.05 },
            pro: { defenderSpeed: 1.0, successBonus: 0, fumbleChance: 0.05, intChance: 0.1 },
            allpro: { defenderSpeed: 1.3, successBonus: -0.1, fumbleChance: 0.08, intChance: 0.15 },
            legend: { defenderSpeed: 1.6, successBonus: -0.2, fumbleChance: 0.12, intChance: 0.2 }
        };

        // Playbook
        const PLAYS = {
            run: [
                { name: 'Dive Run', type: 'run', icon: '‚Üí', success: 0.6, yards: [2, 8], target: 'RB' },
                { name: 'Power Run', type: 'run', icon: '‚áâ', success: 0.55, yards: [3, 10], target: 'RB' },
                { name: 'Sweep Run', type: 'run', icon: '‚Üó', success: 0.5, yards: [0, 12], target: 'RB' },
                { name: 'Zone Read', type: 'run', icon: '‚áÑ', success: 0.58, yards: [1, 15], target: 'QB' }
            ],
            pass: [
                { name: 'Slant Route', type: 'pass', icon: '‚§¢', success: 0.7, yards: [5, 12], target: 'WR1' },
                { name: 'Post Route', type: 'pass', icon: '‚Üë', success: 0.6, yards: [15, 30], target: 'WR2' },
                { name: 'Out Route', type: 'pass', icon: '‚Üí', success: 0.65, yards: [7, 15], target: 'WR1' },
                { name: 'Deep Pass', type: 'pass', icon: '‚áà', success: 0.45, yards: [20, 50], target: 'WR3' }
            ]
        };

        // Defensive Playbook with down/distance probabilities
        const DEFENSIVE_PLAYS = {
            coverage: [
                { name: 'Cover 2', vsRun: 0.5, vsPass: 0.7, downPreference: [2, 3], distancePreference: 'medium' },
                { name: 'Cover 3', vsRun: 0.6, vsPass: 0.65, downPreference: [1, 2], distancePreference: 'any' },
                { name: 'Man Coverage', vsRun: 0.4, vsPass: 0.8, downPreference: [3, 4], distancePreference: 'long' },
                { name: 'Cover 4', vsRun: 0.7, vsPass: 0.5, downPreference: [3, 4], distancePreference: 'long' }
            ],
            pressure: [
                { name: 'Blitz', vsRun: 0.8, vsPass: 0.6, downPreference: [2, 3], distancePreference: 'short' },
                { name: 'Nickel Defense', vsRun: 0.5, vsPass: 0.75, downPreference: [2, 3], distancePreference: 'medium' },
                { name: 'Dime Defense', vsRun: 0.3, vsPass: 0.85, downPreference: [3, 4], distancePreference: 'long' },
                { name: 'Goal Line', vsRun: 0.9, vsPass: 0.4, downPreference: [1, 2, 3, 4], distancePreference: 'short' }
            ]
        };

        // Helper function to format yard line in NFL terminology
        function formatYardLine(position) {
            if (position === 50) {
                return 'Midfield';
            } else if (position < 50) {
                return `Own ${position}`;
            } else {
                return `Opp ${100 - position}`;
            }
        }

        // Format down
        function formatDown(down) {
            const suffixes = ['st', 'nd', 'rd', 'th'];
            const suffix = suffixes[Math.min(down - 1, 3)];
            return `${down}${suffix}`;
        }

        // Format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // AI Defensive Play Selection based on down/distance
        function selectDefensivePlay(down, yardsToGo, ballPosition) {
            let distanceType = 'short';
            if (yardsToGo > 7) distanceType = 'long';
            else if (yardsToGo > 3) distanceType = 'medium';

            // Near goal line, prioritize goal line defense
            if (ballPosition > 90) {
                const goalLinePlay = [...DEFENSIVE_PLAYS.pressure].find(p => p.name === 'Goal Line');
                if (goalLinePlay) return goalLinePlay;
            }

            // Combine all plays and score them based on situation
            const allPlays = [...DEFENSIVE_PLAYS.coverage, ...DEFENSIVE_PLAYS.pressure];
            const scoredPlays = allPlays.map(play => {
                let score = 0;
                
                // Down preference
                if (play.downPreference.includes(down)) score += 3;
                
                // Distance preference
                if (play.distancePreference === 'any' || play.distancePreference === distanceType) score += 2;
                
                // Long yardage situations favor pass defense
                if (yardsToGo > 10 && play.vsPass > 0.7) score += 2;
                
                // Short yardage favors run defense
                if (yardsToGo <= 3 && play.vsRun > 0.7) score += 2;

                // 4th down - all out pressure
                if (down === 4) {
                    if (play.name === 'Blitz') score += 3;
                }

                return { play, score };
            });

            // Sort by score and pick from top 3 for variety
            scoredPlays.sort((a, b) => b.score - a.score);
            const topPlays = scoredPlays.slice(0, 3);
            const selected = topPlays[Math.floor(Math.random() * topPlays.length)];
            
            return selected.play;
        }

        // Load NFL Teams
        async function loadNFLTeams() {
            if (gameState.nflTeams.length > 0) return;
            
            try {
                const response = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams?limit=32');
                const data = await response.json();
                
                gameState.nflTeams = data.sports[0].leagues[0].teams.map(team => {
                    const t = team.team;
                    return {
                        id: t.id,
                        name: t.displayName,
                        abbreviation: t.abbreviation,
                        color: t.color || '#3b82f6',
                        rating: 75 + Math.floor(Math.random() * 20),
                        roster: {
                            qb: { name: 'Quarterback', jersey: '12', position: 'QB', speed: 75, power: 75, hands: 75 },
                            rb: { name: 'Running Back', jersey: '28', position: 'RB', speed: 85, power: 80, hands: 70 },
                            wr: [
                                { name: 'WR 1', jersey: '80', position: 'WR', speed: 90, power: 70, hands: 85 },
                                { name: 'WR 2', jersey: '81', position: 'WR', speed: 88, power: 72, hands: 83 },
                                { name: 'WR 3', jersey: '82', position: 'WR', speed: 87, power: 71, hands: 84 }
                            ]
                        }
                    };
                });
            } catch (error) {
                console.error('Error loading teams:', error);
                gameState.nflTeams = generateFallbackTeams();
            }
        }

        function generateFallbackTeams() {
            const teams = ['Cardinals', 'Falcons', 'Ravens', 'Bills', 'Panthers', 'Bears', 'Bengals', 'Browns'];
            return teams.map((name, idx) => ({
                id: idx + 1,
                name: name,
                color: `hsl(${idx * 45}, 70%, 50%)`,
                rating: 75 + Math.floor(Math.random() * 15),
                roster: {
                    qb: { name: 'QB', jersey: '12', speed: 75, power: 75, hands: 75 },
                    rb: { name: 'RB', jersey: '28', speed: 85, power: 80, hands: 70 },
                    wr: [
                        { name: 'WR1', jersey: '80', speed: 90, power: 70, hands: 85 },
                        { name: 'WR2', jersey: '81', speed: 88, power: 72, hands: 83 },
                        { name: 'WR3', jersey: '82', speed: 87, power: 71, hands: 84 }
                    ]
                }
            }));
        }

        // Initialize season
        async function initializeSeason(playerTeamIndex) {
            gameState.season.playerTeam = gameState.nflTeams[playerTeamIndex];
            gameState.season.teams = gameState.nflTeams.map((team, idx) => ({
                ...team,
                wins: 0,
                losses: 0,
                isPlayer: idx === playerTeamIndex
            }));
            
            gameState.season.schedule = [];
            const opponents = gameState.season.teams.filter(t => !t.isPlayer);
            for (let i = 0; i < 7; i++) {
                gameState.season.schedule.push({
                    week: i + 1,
                    opponent: opponents[i % opponents.length],
                    played: false
                });
            }
            
            gameState.mode = 'season';
        }

        // Start game
        async function startGame(opponent) {
            gameState.game.opponent = opponent;
            gameState.game.possession = 'player';
            gameState.mode = 'playSelect';
        }

        // Show play selection UI - UPDATED with play clock warning
        function showPlaySelect() {
            const overlay = document.createElement('div');
            overlay.className = 'ui-overlay';
            
            const panel = document.createElement('div');
            panel.className = 'ui-panel';
            
            // Show play clock warning if clock is running
            const playClockHTML = gameState.game.playClockShouldStart ? `
                <div class="play-clock-warning">
                    <div style="color: #fbbf24; font-size: 24px; font-weight: bold;">‚è±Ô∏è CLOCK IS RUNNING!</div>
                    <div style="color: white; font-size: 16px; margin-top: 5px;">Select play quickly - 40 second play clock will start</div>
                </div>
            ` : '';
            
            panel.innerHTML = `
                <div class="ui-title">üèà Call Your Play üèà</div>
                ${playClockHTML}
                <div class="game-info">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div><strong>${gameState.season.playerTeam.name}:</strong> ${gameState.game.playerScore}</div>
                        <div><strong>${gameState.game.opponent.name}:</strong> ${gameState.game.opponentScore}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div><strong>Quarter:</strong> ${gameState.game.quarter}</div>
                        <div><strong>Time:</strong> ${formatTime(gameState.game.timeLeft)}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <div><strong>Down:</strong> ${formatDown(gameState.game.down)} & ${gameState.game.yardsToGo}</div>
                        <div><strong>Ball:</strong> ${formatYardLine(gameState.game.ballPosition)}</div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3 style="color: #10b981; margin-bottom: 10px;">üèÉ Running Plays</h3>
                    <div class="play-grid">
                        ${PLAYS.run.map(play => `
                            <button class="play-button run" onclick="selectPlay('${play.name}')">
                                ${play.icon} ${play.name}
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3 style="color: #f59e0b; margin-bottom: 10px;">üéØ Passing Plays</h3>
                    <div class="play-grid">
                        ${PLAYS.pass.map(play => `
                            <button class="play-button pass" onclick="selectPlay('${play.name}')">
                                ${play.icon} ${play.name}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
        }

        // Select play
        function selectPlay(playName) {
            const allPlays = [...PLAYS.run, ...PLAYS.pass];
            const play = allPlays.find(p => p.name === playName);
            if (!play) return;
            
            gameState.game.selectedPlay = play;
            document.querySelector('.ui-overlay').remove();
            
            // AI selects defensive play based on situation
            const aiDefensivePlay = selectDefensivePlay(
                gameState.game.down,
                gameState.game.yardsToGo,
                gameState.game.ballPosition
            );
            console.log(`AI selected ${aiDefensivePlay.name} (vsRun: ${aiDefensivePlay.vsRun}, vsPass: ${aiDefensivePlay.vsPass})`);
            
            setupPlay(play);
        }

        // Setup play - UPDATED for proper gameplay
        function setupPlay(play) {
            gameState.game.players = [];
            
            const fieldWidth = canvas.width * 0.8;
            const fieldX = canvas.width * 0.1;
            const lineOfScrimmage = fieldX + (fieldWidth * gameState.game.ballPosition / 100);
            const centerY = canvas.height / 2;
            
            const roster = gameState.season.playerTeam.roster;
            
            // Create QB with ball
            const qbPlayer = {
                type: 'QB',
                x: lineOfScrimmage - 30,
                y: centerY,
                vx: 0,
                vy: 0,
                hasBall: true,
                team: 'player',
                number: roster.qb.jersey,
                name: roster.qb.name,
                stats: roster.qb,
                color: gameState.season.playerTeam.color
            };
            gameState.game.players.push(qbPlayer);
            
            if (play.type === 'run') {
                // RB
                const rb = roster.rb;
                gameState.game.players.push({
                    type: 'RB',
                    x: lineOfScrimmage - 50,
                    y: centerY + 30,
                    vx: 0,
                    vy: 0,
                    hasBall: false,
                    team: 'player',
                    number: rb.jersey,
                    name: rb.name,
                    stats: rb,
                    color: gameState.season.playerTeam.color,
                    isTarget: play.target === 'RB'
                });
                
                // For run plays, automatically hand off to RB after snap
                setTimeout(() => {
                    const rbPlayer = gameState.game.players.find(p => p.type === 'RB' && p.team === 'player');
                    if (rbPlayer && gameState.game.ballCarrier) {
                        gameState.game.ballCarrier.hasBall = false;
                        rbPlayer.hasBall = true;
                        gameState.game.ballCarrier = rbPlayer;
                        showMessage('Handoff to RB!');
                    }
                }, 500);
            } else {
                // Pass play - add receivers
                roster.wr.forEach((wr, i) => {
                    gameState.game.players.push({
                        type: 'WR',
                        x: lineOfScrimmage,
                        y: [centerY - 150, centerY, centerY + 150][i],
                        vx: 0,
                        vy: 0,
                        hasBall: false,
                        team: 'player',
                        number: wr.jersey,
                        name: wr.name,
                        stats: wr,
                        route: play.name,
                        routeProgress: 0,
                        color: gameState.season.playerTeam.color,
                        isTarget: play.target === `WR${i + 1}`
                    });
                });
            }
            
            // Add defenders
            for (let i = 0; i < 4; i++) {
                gameState.game.players.push({
                    type: 'DL',
                    x: lineOfScrimmage + 20,
                    y: [centerY - 70, centerY - 25, centerY + 25, centerY + 70][i],
                    vx: 0,
                    vy: 0,
                    team: 'opponent',
                    number: 90 + i,
                    color: gameState.game.opponent.color
                });
            }
            
            gameState.game.ballCarrier = qbPlayer;
            gameState.game.gamePhase = 'active';
            gameState.mode = 'playing';
            showControlsKey();
        }

        // Show controls
        function showControlsKey() {
            if (document.querySelector('.controls-key')) return;
            
            const controls = document.createElement('div');
            controls.className = 'controls-key';
            controls.innerHTML = `
                <h4>üéÆ Controls</h4>
                <div class="control-item">
                    <span class="control-key">WASD / Arrows</span>
                    <span class="control-action">Move</span>
                </div>
                <div class="control-item">
                    <span class="control-key">1-3</span>
                    <span class="control-action">Pass to WR</span>
                </div>
                <div class="control-item">
                    <span class="control-key">Space</span>
                    <span class="control-action">Juke</span>
                </div>
                <div class="control-item">
                    <span class="control-key">Shift</span>
                    <span class="control-action">Sprint</span>
                </div>
            `;
            document.body.appendChild(controls);
        }

        function hideControlsKey() {
            const key = document.querySelector('.controls-key');
            if (key) key.remove();
        }

        // Game loop
        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            // Clear canvas
            ctx.fillStyle = '#1a3a0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw field
            const fieldX = canvas.width * 0.1;
            const fieldWidth = canvas.width * 0.8;
            const fieldY = canvas.height * 0.2;
            const fieldHeight = canvas.height * 0.6;
            
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.strokeRect(fieldX, fieldY, fieldWidth, fieldHeight);
            
            // Draw yard lines
            for (let i = 0; i <= 10; i++) {
                const x = fieldX + (fieldWidth / 10) * i;
                ctx.beginPath();
                ctx.moveTo(x, fieldY);
                ctx.lineTo(x, fieldY + fieldHeight);
                ctx.stroke();
            }
            
            // Update and draw players
            if (gameState.mode === 'playing') {
                updateGameplay(deltaTime);
                drawPlayers();
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Update gameplay - FIXED to enable proper control
        function updateGameplay(deltaTime) {
            const dt = deltaTime / 16.67;
            const difficulty = DIFFICULTY[gameState.difficulty];
            
            if (gameState.game.ballCarrier) {
                const carrier = gameState.game.ballCarrier;
                
                if (carrier.team === 'player') {
                    const speed = 3 * dt;
                    
                    // Horizontal movement
                    if (gameState.input.keys['ArrowRight'] || gameState.input.keys['d'] || gameState.input.keys['D']) {
                        carrier.vx = speed;
                    } else if (gameState.input.keys['ArrowLeft'] || gameState.input.keys['a'] || gameState.input.keys['A']) {
                        carrier.vx = -speed;
                    } else {
                        carrier.vx *= 0.9;
                    }
                    
                    // Vertical movement
                    if (gameState.input.keys['ArrowUp'] || gameState.input.keys['w'] || gameState.input.keys['W']) {
                        carrier.vy = -speed;
                    } else if (gameState.input.keys['ArrowDown'] || gameState.input.keys['s'] || gameState.input.keys['S']) {
                        carrier.vy = speed;
                    } else {
                        carrier.vy *= 0.9;
                    }
                    
                    // Sprint
                    if (gameState.input.keys['Shift']) {
                        carrier.vx *= 1.5;
                        carrier.vy *= 1.5;
                    }
                }
                
                carrier.x += carrier.vx;
                carrier.y += carrier.vy;
                
                // Boundary check
                const fieldX = canvas.width * 0.1;
                const fieldWidth = canvas.width * 0.8;
                const fieldY = canvas.height * 0.2;
                const fieldHeight = canvas.height * 0.6;
                
                carrier.x = Math.max(fieldX, Math.min(fieldX + fieldWidth, carrier.x));
                carrier.y = Math.max(fieldY, Math.min(fieldY + fieldHeight, carrier.y));
                
                // Check for touchdown
                if (carrier.x >= fieldX + fieldWidth * 0.95) {
                    scoreTouchdown();
                }
            }
            
            // Update receivers
            gameState.game.players.forEach(player => {
                if (player.type === 'WR' && !player.hasBall) {
                    player.routeProgress += 0.02 * dt;
                    player.vx = 2 * dt;
                    player.x += player.vx;
                }
                
                // Update defenders
                if (player.team === 'opponent' && gameState.game.ballCarrier) {
                    const carrier = gameState.game.ballCarrier;
                    const dx = carrier.x - player.x;
                    const dy = carrier.y - player.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    const defenderSpeed = 1.5 * dt * difficulty.defenderSpeed;
                    
                    if (dist > 20) {
                        player.vx = (dx / dist) * defenderSpeed;
                        player.vy = (dy / dist) * defenderSpeed;
                        player.x += player.vx;
                        player.y += player.vy;
                    }
                    
                    // Check for tackle
                    if (dist < 25) {
                        tacklePlay();
                    }
                }
            });
        }

        // Draw players
        function drawPlayers() {
            gameState.game.players.forEach(player => {
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(player.x, player.y, 15, 0, Math.PI * 2);
                ctx.fill();
                
                if (player.hasBall) {
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(player.number, player.x, player.y + 4);
            });
        }

        // Pass to receiver
        function passToReceiver(receiverIndex) {
            const receivers = gameState.game.players.filter(p => p.type === 'WR' && p.team === 'player');
            if (receiverIndex >= receivers.length) return;
            
            const receiver = receivers[receiverIndex];
            const qb = gameState.game.ballCarrier;
            
            if (qb && qb.type === 'QB') {
                const difficulty = DIFFICULTY[gameState.difficulty];
                const passSuccess = Math.random() < (gameState.game.selectedPlay.success + difficulty.successBonus);
                
                if (passSuccess) {
                    qb.hasBall = false;
                    receiver.hasBall = true;
                    gameState.game.ballCarrier = receiver;
                    showMessage('Complete!');
                } else {
                    showMessage('Incomplete!');
                    tacklePlay();
                }
            }
        }

        // Tackle play
        function tacklePlay() {
            if (gameState.game.gamePhase === 'tackle') return;
            
            gameState.game.gamePhase = 'tackle';
            hideControlsKey();
            
            // Calculate yards gained
            const fieldX = canvas.width * 0.1;
            const fieldWidth = canvas.width * 0.8;
            const lineOfScrimmage = fieldX + (fieldWidth * gameState.game.ballPosition / 100);
            const endX = gameState.game.ballCarrier.x;
            let yardsGained = Math.round((endX - lineOfScrimmage) / fieldWidth * 100);
            
            const play = gameState.game.selectedPlay;
            const [minYards, maxYards] = play.yards;
            yardsGained = Math.max(minYards, Math.min(maxYards, yardsGained));
            
            gameState.game.ballPosition += yardsGained;
            gameState.game.yardsToGo -= yardsGained;
            
            if (play.type === 'pass') {
                gameState.game.stats.passingYards += yardsGained;
            } else {
                gameState.game.stats.rushingYards += yardsGained;
            }
            
            // Check for first down
            if (gameState.game.yardsToGo <= 0) {
                gameState.game.down = 1;
                gameState.game.yardsToGo = 10;
                showMessage(`First Down! ${yardsGained} yards`);
                showBigPlayAlert('FIRST DOWN! üéØ');
            } else {
                gameState.game.down++;
                showMessage(`${yardsGained} yards`);
            }
            
            // Check for turnover
            if (gameState.game.down > 4) {
                showMessage('Turnover on Downs');
                gameState.game.ballPosition = 25;
                gameState.game.down = 1;
                gameState.game.yardsToGo = 10;
            }
            
            setTimeout(() => {
                gameState.game.gamePhase = 'setup';
                gameState.mode = 'playSelect';
            }, 2000);
        }

        // Score touchdown
        function scoreTouchdown() {
            gameState.game.gamePhase = 'tackle';
            gameState.game.stats.touchdowns++;
            gameState.game.playerScore += 7;
            hideControlsKey();
            
            showBigPlayAlert('TOUCHDOWN! üèàüî•');
            
            setTimeout(() => {
                gameState.game.ballPosition = 25;
                gameState.game.down = 1;
                gameState.game.yardsToGo = 10;
                gameState.mode = 'playSelect';
            }, 3000);
        }

        // Show message
        function showMessage(text) {
            const msg = document.createElement('div');
            msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:white;padding:15px 30px;border-radius:8px;font-size:18px;font-weight:bold;z-index:3000;';
            msg.textContent = text;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2000);
        }

        // Show big play alert
        function showBigPlayAlert(text) {
            const div = document.createElement('div');
            div.className = 'big-play-alert';
            div.textContent = text;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

        // Input handling
        document.addEventListener('keydown', (e) => {
            gameState.input.keys[e.key] = true;
            
            // Pass to receivers
            if (e.key >= '1' && e.key <= '3') {
                passToReceiver(parseInt(e.key) - 1);
            }
        });

        document.addEventListener('keyup', (e) => {
            gameState.input.keys[e.key] = false;
        });

        canvas.addEventListener('mousedown', (e) => {
            gameState.input.touching = true;
            gameState.input.mouseX = e.offsetX;
            gameState.input.mouseY = e.offsetY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (gameState.input.touching) {
                gameState.input.mouseX = e.offsetX;
                gameState.input.mouseY = e.offsetY;
            }
        });

        canvas.addEventListener('mouseup', () => {
            gameState.input.touching = false;
        });

        // Menu system
        function showMenu() {
            const overlay = document.createElement('div');
            overlay.className = 'ui-overlay';
            
            const panel = document.createElement('div');
            panel.className = 'ui-panel';
            panel.innerHTML = `
                <div class="ui-title">üèà NFL Pro Season</div>
                <div style="text-align: center; margin: 40px 0;">
                    <button class="action-button" onclick="startNewSeason()">
                        Start New Season
                    </button>
                </div>
            `;
            
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
        }

        async function startNewSeason() {
            document.querySelector('.ui-overlay').remove();
            await loadNFLTeams();
            showTeamSelect();
        }

        function showTeamSelect() {
            const overlay = document.createElement('div');
            overlay.className = 'ui-overlay';
            
            const panel = document.createElement('div');
            panel.className = 'ui-panel';
            panel.innerHTML = `
                <div class="ui-title">Select Your Team</div>
                <div class="team-select">
                    ${gameState.nflTeams.map((team, idx) => `
                        <div class="team-card" onclick="selectTeam(${idx})">
                            <div style="font-size: 24px; margin-bottom: 10px;">${team.name}</div>
                            <div style="font-size: 14px; opacity: 0.8;">Rating: ${team.rating}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
        }

        async function selectTeam(teamIndex) {
            document.querySelector('.ui-overlay').remove();
            await initializeSeason(teamIndex);
            showSchedule();
        }

        function showSchedule() {
            const overlay = document.createElement('div');
            overlay.className = 'ui-overlay';
            
            const panel = document.createElement('div');
            panel.className = 'ui-panel';
            panel.innerHTML = `
                <div class="ui-title">${gameState.season.playerTeam.name} Schedule</div>
                <div style="margin: 20px 0;">
                    ${gameState.season.schedule.map(game => `
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 16px; color: white;">Week ${game.week}</div>
                                <div style="font-size: 20px; font-weight: bold; color: ${game.opponent.color};">${game.opponent.name}</div>
                            </div>
                            ${!game.played ? `
                                <button class="action-button" onclick="playGame(${game.week - 1})">
                                    Play Game
                                </button>
                            ` : `
                                <div style="color: #10b981; font-weight: bold;">${game.won ? 'W' : 'L'}</div>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
            
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
        }

        async function playGame(weekIndex) {
            const game = gameState.season.schedule[weekIndex];
            document.querySelector('.ui-overlay').remove();
            await startGame(game.opponent);
        }

        // Initialize
        showMenu();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>